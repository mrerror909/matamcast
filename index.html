<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">مراقب البثوث المباشرة</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ... نفس التنسيقات من الملف الأصلي ... */
    </style>
</head>
<body>
    <!-- نفس الواجهة من الملف الأصلي -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCNjqLeuj03klcwHbs3jxSIJk1RJ3zcbnc",
            authDomain: "livematam-5b050.firebaseapp.com",
            projectId: "livematam-5b050",
            storageBucket: "livematam-5b050.firebasestorage.app",
            messagingSenderId: "411694644929",
            appId: "1:411694644929:web:50681d37ed7e0dd1965e40",
            measurementId: "G-TE3KKNE1LH"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let channels = [];
        let siteSettings = {};
        
        async function loadSiteSettings() {
            try {
                const docSnap = await db.collection('settings').doc('site').get();
                if (docSnap.exists) {
                    siteSettings = docSnap.data();
                    updateSiteHeader();
                }
            } catch (error) {
                console.error('Error loading site settings:', error);
            }
        }
        
        function updateSiteHeader() {
            if (siteSettings.siteName) {
                document.getElementById('siteName').textContent = siteSettings.siteName;
                document.getElementById('pageTitle').textContent = siteSettings.siteName;
            }
            if (siteSettings.siteDescription) {
                document.getElementById('siteDescription').textContent = siteSettings.siteDescription;
            }
            if (siteSettings.siteLogo) {
                const logoContainer = document.getElementById('siteHeader');
                logoContainer.innerHTML = `
                    <img src="${siteSettings.siteLogo}" alt="الشعار">
                    <div class="site-title">
                        <div class="site-name">${siteSettings.siteName || 'مراقب البثوث'}</div>
                        <div class="site-description">${siteSettings.siteDescription || 'منصة مراقبة البثوث المباشرة'}</div>
                    </div>
                `;
            }
        }
        
        async function loadChannels() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('channels').style.display = 'none';
            
            try {
                const snapshot = await db.collection('channels').get();
                channels = [];
                
                if (snapshot.empty) {
                    showEmptyState();
                } else {
                    snapshot.forEach(doc => {
                        channels.push({ id: doc.id, ...doc.data() });
                    });
                    await updateChannelsWithYouTubeData();
                    renderChannels();
                }
                
                updateStats();
            } catch (error) {
                console.error('Error loading channels:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        async function updateChannelsWithYouTubeData() {
            try {
                const apiKeyDoc = await db.collection('settings').doc('youtube').get();
                if (!apiKeyDoc.exists || !apiKeyDoc.data().apiKey) {
                    console.log('No YouTube API key found');
                    return;
                }
                
                const apiKey = apiKeyDoc.data().apiKey;
                
                for (let channel of channels) {
                    const channelIdOrName = extractChannelId(channel.url);
                    if (!channelIdOrName) continue;
        
                    await fetchChannelData(channelIdOrName, apiKey, channel);
        
                    if (channel.realChannelId) {
                        await fetchLiveStreamData(channel.realChannelId, apiKey, channel);
                    } else {
                        await fetchLiveStreamData(channelIdOrName, apiKey, channel);
                    }
        
                    if (channel.status === 'offline' && channel.realChannelId) {
                        console.log(`Retrying for channel: ${channel.title}`);
                        await new Promise(r => setTimeout(r, 1000));
                        await fetchLiveStreamData(channel.realChannelId, apiKey, channel);
                    }
                }
            } catch (error) {
                console.error('Error updating channels with YouTube data:', error);
            }
        }
        
        function extractChannelId(url) {
            const patterns = [
                /youtube\.com\/channel\/([a-zA-Z0-9_-]+)/,
                /youtube\.com\/c\/([a-zA-Z0-9_-]+)/,
                /youtube\.com\/@([a-zA-Z0-9_-]+)/,
                /youtube\.com\/user\/([a-zA-Z0-9_-]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        async function fetchChannelData(channelId, apiKey, channel) {
            try {
                let apiUrl;
                if (channelId.startsWith('UC') || channelId.length === 24) {
                    apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${apiKey}`;
                } else {
                    apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&forUsername=${channelId}&key=${apiKey}`;
                }
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const channelData = data.items[0];
                    channel.title = channelData.snippet.title;
                    channel.thumbnail = channelData.snippet.thumbnails.medium?.url;
                    channel.description = channelData.snippet.description;
                    channel.subscriberCount = channelData.statistics.subscriberCount;
                    channel.realChannelId = channelData.id;
                }
            } catch (error) {
                console.error('Error fetching channel data:', error);
            }
        }
        
        // ... باقي الدوال من الكود الأصلي بدون تغيير ...
        
        async function initializeApp() {
            await loadSiteSettings();
            await loadChannels();
        }
        
        initializeApp();
        setInterval(loadChannels, 120000);
    </script>
</body>
</html>
