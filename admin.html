<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© â€” Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ© â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%); min-height:100vh; }
        .login-container{ display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
        .login-card{ background:rgba(255,255,255,.95); padding:40px; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.3); text-align:center; max-width:400px; width:100%; }
        .login-icon{ font-size:3rem; color:#3498db; margin-bottom:20px; }
        .login-title{ font-size:1.8rem; color:#2c3e50; margin-bottom:10px; }
        .login-subtitle{ color:#666; margin-bottom:30px; }
        .form-group{ margin-bottom:20px; position:relative; }
        .form-input{ width:100%; padding:15px 20px 15px 50px; border:2px solid #ecf0f1; border-radius:25px; font-size:1rem; transition:all .3s ease; }
        .form-input:focus{ outline:none; border-color:#3498db; box-shadow:0 0 10px rgba(52,152,219,.3); }
        .input-icon{ position:absolute; left:18px; top:50%; transform:translateY(-50%); color:#bdc3c7; }
        .login-btn{ background:linear-gradient(45deg,#3498db,#2980b9); border:none; padding:15px 40px; border-radius:25px; color:#fff; font-weight:600; font-size:1rem; cursor:pointer; transition:all .3s ease; width:100%; }
        .login-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(52,152,219,.4); }

        .admin-panel{ display:none; padding:0; background:#f8f9fa; }
        .admin-navbar{ background:rgba(255,255,255,.95); padding:20px 0; box-shadow:0 2px 20px rgba(0,0,0,.1); position:sticky; top:0; z-index:1000; }
        .nav-container{ max-width:1400px; margin:0 auto; padding:0 20px; display:flex; justify-content:space-between; align-items:center; }
        .admin-logo{ display:flex; align-items:center; gap:10px; color:#2c3e50; font-size:1.5rem; font-weight:bold; }
        .nav-actions{ display:flex; gap:10px; align-items:center; }
        .debug-toggle{ background:linear-gradient(45deg,#9b59b6,#8e44ad); border:none; padding:10px 20px; border-radius:20px; color:#fff; font-weight:600; cursor:pointer; transition:all .3s ease; position:relative; }
        .debug-toggle:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(155,89,182,.4); }
        .debug-toggle.active{ background:linear-gradient(45deg,#e67e22,#d35400); box-shadow:0 4px 12px rgba(230,126,34,.4); }
        .debug-indicator{ position:absolute; top:-5px; right:-5px; background:#e74c3c; color:#fff; border-radius:50%; width:20px; height:20px; font-size:12px; display:none; align-items:center; justify-content:center; }
        .debug-toggle.active .debug-indicator{ display:flex; animation:pulse 2s infinite; }
        @keyframes pulse{ 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }
        .logout-btn{ background:linear-gradient(45deg,#e74c3c,#c0392b); border:none; padding:10px 20px; border-radius:20px; color:#fff; font-weight:600; cursor:pointer; transition:all .3s ease; }
        .logout-btn:hover{ transform:translateY(-2px); }
        .admin-container{ max-width:1400px; margin:0 auto; padding:40px 20px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØµØ­ÙŠØ­ */
        .debug-panel{ background:rgba(26,32,46,.95); color:#00ff88; border:2px solid #00ff88; border-radius:15px; padding:20px; margin-bottom:30px; font-family:'Courier New', monospace; font-size:.9rem; display:none; max-height:500px; overflow-y:auto; backdrop-filter:blur(10px); }
        .debug-panel.show{ display:block; animation:slideDown .3s ease; }
        @keyframes slideDown{ from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
        .debug-header{ background:linear-gradient(45deg,#00ff88,#00cc6a); color:#1a202e; padding:15px 20px; margin:-20px -20px 20px -20px; border-radius:12px 12px 0 0; font-weight:bold; display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .debug-controls{ display:flex; gap:10px; }
        .debug-btn{ background:rgba(26,32,46,.8); color:#00ff88; border:1px solid #00ff88; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:.8rem; }
        .debug-btn:hover{ background:rgba(0,255,136,.1); }
        .debug-section{ margin-bottom:20px; padding:15px; background:rgba(0,255,136,.1); border-radius:8px; border-left:4px solid #00ff88; }
        .debug-title{ color:#00ff88; font-weight:bold; margin-bottom:10px; display:flex; align-items:center; gap:8px; font-size:1rem; }
        .debug-content{ color:#b8e6d1; line-height:1.6; }
        .debug-error{ color:#ff6b6b; background:rgba(255,107,107,.1); padding:5px 10px; border-radius:4px; margin:2px 0; }
        .debug-warning{ color:#ffa726; background:rgba(255,167,38,.1); padding:5px 10px; border-radius:4px; margin:2px 0; }
        .debug-success{ color:#4caf50; background:rgba(76,175,80,.1); padding:5px 10px; border-radius:4px; margin:2px 0; }
        .api-monitor{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin-bottom:15px; }
        .api-stat{ background:rgba(0,255,136,.1); padding:15px; border-radius:8px; text-align:center; border:1px solid rgba(0,255,136,.3); }
        .api-stat-number{ font-size:1.8rem; font-weight:bold; color:#00ff88; }
        .api-stat-label{ font-size:.8rem; color:#b8e6d1; margin-top:8px; }
        .api-quota-warning{ background:rgba(255,193,7,.1); border-left:4px solid #ffc107; padding:15px; border-radius:8px; color:#ffc107; margin-bottom:15px; }
        .api-quota-danger{ background:rgba(220,53,69,.1); border-left:4px solid #dc3545; padding:15px; border-radius:8px; color:#dc3545; margin-bottom:15px; }
        .cache-info{ background:rgba(0,123,255,.1); border-left:4px solid #007bff; padding:15px; border-radius:8px; color:#007bff; margin-bottom:15px; }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ¥Ø·Ø§Ø±Ø§Øª */
        .stats-overview{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:25px; margin-bottom:40px; }
        .stat-card{ background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,.1); text-align:center; transition:transform .3s ease; }
        .stat-card:hover{ transform:translateY(-5px); }
        .stat-icon{ font-size:2.5rem; margin-bottom:15px; }
        .stat-number{ font-size:2.2rem; font-weight:bold; margin-bottom:8px; }
        .stat-label{ color:#666; font-size:1rem; }
        .section-card{ background:#fff; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,.1); margin-bottom:30px; overflow:hidden; }
        .section-header{ background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; padding:25px 30px; display:flex; align-items:center; justify-content:space-between; }
        .section-title-group{ display:flex; align-items:center; gap:15px; }
        .section-title{ font-size:1.4rem; font-weight:600; }
        .section-actions{ display:flex; gap:10px; }
        .header-btn{ background:rgba(255,255,255,.2); border:none; padding:8px 16px; border-radius:20px; color:#fff; font-weight:600; cursor:pointer; transition:all .3s ease; display:flex; align-items:center; gap:5px; }
        .header-btn:hover{ background:rgba(255,255,255,.3); }
        .header-btn:disabled{ opacity:.5; cursor:not-allowed; }
        .section-content{ padding:30px; }

        /* Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© */
        .smart-add{ background:#f8f9fa; border-radius:12px; padding:18px; margin-bottom:20px; border:2px dashed #e9ecef; }
        .smart-add .help{ font-size:.9rem; color:#6c757d; margin-top:8px; }
        .smart-row{ display:grid; grid-template-columns:1fr auto; gap:12px; }
        .smart-input{ padding:12px 14px; border:2px solid #e9ecef; border-radius:10px; font-size:.95rem; }
        .smart-input:focus{ outline:none; border-color:#667eea; }
        .btn-smart{ background:linear-gradient(45deg,#27ae60,#2ecc71); border:none; padding:12px 20px; border-radius:10px; color:#fff; font-weight:700; cursor:pointer; }
        .smart-badges{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
        .smart-badge{ background:#eef2ff; color:#4f46e5; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px; font-size:.8rem; }
        .saving-mode{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; background:rgba(255,193,7,.12); color:#a86a00; border:1px solid #ffd35c; margin-top:8px; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª */
        .channels-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:20px; }
        .item-card{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:20px; transition:all .3s ease; position:relative; }
        .item-card:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.1); }
        .item-card.dragging{ opacity:.5; transform:rotate(5deg); }
        .item-card.cached::before{ content:'ğŸ’¾'; position:absolute; top:10px; left:10px; font-size:1.2rem; opacity:.7; }
        .drag-handle{ position:absolute; top:10px; right:10px; color:#bdc3c7; cursor:grab; font-size:1.2rem; }
        .drag-handle:hover{ color:#667eea; }
        .drag-handle:active{ cursor:grabbing; }
        .item-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px; padding-right:30px; }
        .item-info{ flex:1; }
        .item-name{ font-size:1.2rem; font-weight:600; color:#2c3e50; margin-bottom:5px; }
        .item-url{ color:#3498db; text-decoration:none; font-size:.9rem; word-break:break-all; }
        .item-url:hover{ text-decoration:underline; }
        .item-timestamp{ font-size:.8rem; color:#95a5a6; margin-top:5px; }
        .item-status{ display:inline-block; padding:4px 12px; border-radius:15px; font-size:.8rem; font-weight:600; margin-top:10px; }
        .status-live{ background:#e74c3c; color:#fff; }
        .status-upcoming{ background:#f39c12; color:#fff; }
        .status-offline{ background:#95a5a6; color:#fff; }
        .status-error{ background:#e67e22; color:#fff; }
        .item-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:15px; }
        .btn{ padding:8px 16px; border:none; border-radius:20px; font-weight:600; font-size:.85rem; cursor:pointer; transition:all .3s ease; display:inline-flex; align-items:center; gap:5px; }
        .btn-delete{ background:linear-gradient(45deg,#e74c3c,#c0392b); color:#fff; }
        .status-selector{ padding:8px 15px; border:2px solid #ecf0f1; border-radius:20px; font-size:.9rem; background:#fff; color:#2c3e50; cursor:pointer; }

        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ + API (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) */
        .settings-grid{ display:grid; grid-template-columns:1fr auto; gap:15px; align-items:center; margin-bottom:20px; }
        .settings-input{ width:100%; padding:15px 20px; border:2px solid #ecf0f1; border-radius:25px; font-size:1rem; transition:all .3s ease; }
        .settings-input:focus{ outline:none; border-color:#3498db; box-shadow:0 0 10px rgba(52,152,219,.2); }
        .test-api-btn{ background:linear-gradient(45deg,#f39c12,#e67e22); color:#fff; border:none; padding:10px 20px; border-radius:20px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }

        /* Ù„ÙˆØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· */
        .audit-full{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:2000; align-items:center; justify-content:center; padding:24px; }
        .audit-card{ max-width:1000px; width:100%; background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.35); }
        .audit-head{ background:linear-gradient(45deg,#0ea5e9,#6366f1); color:#fff; padding:18px 20px; display:flex; align-items:center; justify-content:space-between; }
        .audit-actions{ display:flex; gap:10px; }
        .audit-table{ width:100%; border-collapse:collapse; }
        .audit-table th,.audit-table td{ padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:right; font-size:.92rem; }
        .audit-table th{ background:#f8fafc; font-weight:700; }
        .audit-body{ max-height:60vh; overflow:auto; }
        .badge{ padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:700; }
        .b-add{ background:#dcfce7; color:#166534; }
        .b-del{ background:#fee2e2; color:#991b1b; }
        .b-edit{ background:#dbeafe; color:#1e40af; }
        .b-login{ background:#fff7ed; color:#9a3412; }
        .b-clear{ background:#fef3c7; color:#92400e; }
        .group-date{ background:#f1f5f9; color:#334155; font-weight:700; padding:6px 10px; border-radius:8px; margin:10px 0; display:inline-block; }

        .notification{ position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:10px; color:#fff; font-weight:600; z-index:3000; transform:translateX(100%); transition:transform .3s ease; max-width:400px; }
        .notification.show{ transform:translateX(0); }
        .notification.success{ background:linear-gradient(45deg,#27ae60,#2ecc71); }
        .notification.error{ background:linear-gradient(45deg,#e74c3c,#c0392b); }
        .notification.warning{ background:linear-gradient(45deg,#f39c12,#e67e22); }

        .loading{ text-align:center; padding:40px; color:#7f8c8d; }
        .spinner{ border:3px solid rgba(127,140,141,.3); border-radius:50%; border-top:3px solid #7f8c8d; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px auto; }
        @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

        @media (max-width: 768px){
            .stats-overview{ grid-template-columns:repeat(2,1fr); }
            .settings-grid{ grid-template-columns:1fr; }
            .item-actions{ flex-direction:column; }
            .admin-container{ padding:20px 15px; }
            .nav-actions{ flex-direction:column; gap:5px; }
            .channels-grid{ grid-template-columns:1fr; }
            .api-monitor{ grid-template-columns:repeat(2,1fr); }
            .smart-row{ grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-icon"><i class="fas fa-shield-alt"></i></div>
            <h2 class="login-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p class="login-subtitle">Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
            <div class="form-group">
                <input type="password" id="adminPass" class="form-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <i class="fas fa-lock input-icon"></i>
            </div>
            <button class="login-btn" onclick="login()"><i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <nav class="admin-navbar">
            <div class="nav-container">
                <div class="admin-logo"><i class="fas fa-cogs"></i><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</span></div>
                <div class="nav-actions">
                    <button class="header-btn" onclick="openAuditFull()"><i class="fas fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="debug-toggle" onclick="toggleDebug()" title="ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­"><i class="fas fa-bug"></i> ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ <div class="debug-indicator">!</div></button>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </nav>

        <div class="admin-container">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
            <div class="debug-panel" id="debugPanel">
                <div class="debug-header">
                    <div style="display:flex; align-items:center; gap:10px;"><i class="fas fa-terminal"></i> ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Ø´Ø·</div>
                    <div class="debug-controls">
                        <button class="debug-btn" onclick="clearCache()" title="Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´</button>
                        <button class="debug-btn" onclick="clearDebugLog()" title="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„"><i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                        <button class="debug-btn" onclick="exportDebugData()" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±</button>
                    </div>
                </div>
                <div class="debug-section">
                    <div class="debug-title"><i class="fas fa-chart-line"></i> Ù…Ø±Ø§Ù‚Ø¨ YouTube API Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
                    <div id="apiQuotaWarning"></div>
                    <div class="api-monitor" id="apiMonitor">
                        <div class="api-stat"><div class="api-stat-number" id="apiCallsCount">0</div><div class="api-stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…Ø©</div></div>
                        <div class="api-stat"><div class="api-stat-number" id="apiQuotaRemaining">1000</div><div class="api-stat-label">Ø­ØµØ© Ù…ØªØ¨Ù‚ÙŠØ©</div></div>
                        <div class="api-stat"><div class="api-stat-number" id="cacheHitRate">0%</div><div class="api-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒØ§Ø´</div></div>
                        <div class="api-stat"><div class="api-stat-number" id="cacheSizeDisplay">0</div><div class="api-stat-label">Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ø´</div></div>
                    </div>
                    <div class="debug-content" id="priorityPreview"></div>
                </div>
                <div class="debug-section">
                    <div class="debug-title"><i class="fas fa-database"></i> Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø°ÙƒÙŠ</div>
                    <div class="debug-content" id="cacheStatus">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØ§Ø´...</div>
                </div>
                <div class="debug-section">
                    <div class="debug-title"><i class="fas fa-memory"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    <div class="debug-content" id="systemStatus">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
                </div>
                <div class="debug-section">
                    <div class="debug-title"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
                    <div class="debug-content" id="debugLog"><div class="debug-success">âœ“ ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div></div>
                </div>
            </div>

            <div class="stats-overview" id="statsOverview"></div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-group"><i class="fas fa-inbox"></i><h3 class="section-title">Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3></div>
                </div>
                <div class="section-content">
                    <div id="requestsLoading" class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p></div>
                    <div id="requests"></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-group"><i class="fas fa-tv"></i><h3 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3></div>
                    <div class="section-actions">
                        <button class="header-btn" onclick="toggleQuickAdd()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button>
                        <button class="header-btn" onclick="refreshChannelData()" id="refreshBtn"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <button class="header-btn" onclick="optimizeChannels()" id="optimizeBtn"><i class="fas fa-magic"></i> ØªØ­Ø³ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                    </div>
                </div>
                <div class="section-content">
                    <!-- ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© -->
                    <div class="smart-add">
                        <div class="smart-row">
                            <input type="text" id="smartChannelInput" class="smart-input" placeholder="Ø£Ù„ØµÙÙ‚ Ø±Ø§Ø¨Ø·/Ø§ÙƒØªØ¨ @Ù…Ø¹Ø±Ù‘Ù/ UCxxxx / Ø§Ø³Ù… Ù…Ø®ØµØµ">
                            <button class="btn-smart" onclick="addSmartChannel()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</button>
                        </div>
                        <div class="help">Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø±Ù†: Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„ | @Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… | Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© UC | Ø§Ø³Ù… Ù…Ø®ØµÙ‘Øµ. <span id="savingModeBadge" class="saving-mode" style="display:none;"><i class="fas fa-leaf"></i> ÙˆØ¶Ø¹ ØªÙˆÙÙŠØ± Ù…ÙØ¹Ù‘Ù„: Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚Ù‹Ø§</span></div>
                        <div class="smart-badges">
                            <span class="smart-badge">ØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                            <span class="smart-badge">ØªØ­Ø¯ÙŠØ« Ø°ÙƒÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</span>
                            <span class="smart-badge">ØªÙˆØ²ÙŠØ¹ Ø­Ù…Ù„ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚</span>
                        </div>
                    </div>

                    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙŠØ¨Ù‚Ù‰ Ù…ØªØ§Ø­Ù‹Ø§ -->
                    <div class="quick-add-form" id="quickAddForm">
                        <div class="smart-row">
                            <input type="text" id="quickChannelName" class="smart-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©">
                            <button class="btn-smart" onclick="addChannelQuick()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div class="help">ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ ØµÙŠØºØ©.</div>
                    </div>

                    <div class="loading" id="channelsLoading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª...</p></div>
                    <div class="channels-grid" id="channels"></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header"><div class="section-title-group"><i class="fas fa-palette"></i><h3 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3></div></div>
                <div class="section-content">
                    <div class="settings-grid"><input type="text" id="siteName" class="settings-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹"><button class="btn test-api-btn" onclick="saveSiteSettings()"><i class="fas fa-save"></i> Ø­ÙØ¸</button></div>
                    <div class="settings-grid"><input type="text" id="siteDescription" class="settings-input" placeholder="ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹"></div>
                    <div class="settings-grid">
                        <div class="file-input-wrapper"><input type="file" id="siteLogo" class="file-input" accept="image/*" onchange="handleLogoUpload(this)"><label for="siteLogo" class="header-btn"><i class="fas fa-upload"></i> Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</label></div>
                    </div>
                    <div class="settings-grid"><input type="email" id="contactEmail" class="settings-input" placeholder="admin@example.com"><button class="btn test-api-btn" onclick="saveContactSettings()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</button></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header"><div class="section-title-group"><i class="fas fa-cog"></i><h3 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª YouTube API</h3></div></div>
                <div class="section-content">
                    <div class="settings-grid"><input type="text" id="ytKey" class="settings-input" placeholder="YouTube API Key"><button class="btn test-api-btn" onclick="saveKey()"><i class="fas fa-save"></i> Ø­ÙØ¸</button></div>
                    <div class="settings-grid"><div></div><button class="test-api-btn" onclick="testYouTubeAPI()"><i class="fas fa-flask"></i> Ø§Ø®ØªØ¨Ø§Ø± API</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· ÙƒØ§Ù…Ù„Ø© -->
    <div class="audit-full" id="auditFull">
        <div class="audit-card">
            <div class="audit-head">
                <div style="display:flex; align-items:center; gap:10px;"><i class="fas fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· (Audit Log)</div>
                <div class="audit-actions">
                    <button class="header-btn" onclick="exportAuditJSON()"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± JSON</button>
                    <button class="header-btn" onclick="confirmClearAudit()"><i class="fas fa-broom"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                    <button class="header-btn" onclick="closeAuditFull()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
            <div class="audit-body">
                <table class="audit-table">
                    <thead>
                        <tr><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr>
                    </thead>
                    <tbody id="auditTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script>
        // â€”â€”â€”â€”â€” ØªÙ‡ÙŠØ¦Ø© Firebase (Ù†ÙØ³ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©) â€”â€”â€”â€”â€”
        const firebaseConfig = {
            apiKey: "AIzaSyCNjqLeuj03klcwHbs3jxSIJk1RJ3zcbnc",
            authDomain: "livematam-5b050.firebaseapp.com",
            projectId: "livematam-5b050",
            storageBucket: "livematam-5b050.firebasestorage.app",
            messagingSenderId: "411694644929",
            appId: "1:411694644929:web:50681d37ed7e0dd1965e40",
            measurementId: "G-TE3KKNE1LH"
        };

        // â€”â€”â€”â€”â€” Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© â€”â€”â€”â€”â€”
        let db, storage;
        const adminPassword = "admin123"; // ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦ÙŠ
        let requests = []; let channels = []; let siteSettings = {}; let contactSettings = {};
        let debugMode = false; let draggedElement = null; let isLoggedIn = false;

        // Ù…Ø±Ø§Ù‚Ø¨Ø© API
        let apiCallCount = 0; let lastApiReset = Date.now(); let cacheHits = 0; let totalRequests = 0; let debugMessages = [];

        // ÙƒØ§Ø´ Ø°ÙƒÙŠ
        const CACHE_DURATION = 6 * 60 * 60 * 1000; // 6 Ø³Ø§Ø¹Ø§Øª
        const CACHE_PREFIX = 'yt_cache_';
        let cacheStats = { size:0, hits:0, misses:0, lastCleanup:Date.now() };

        // Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØªØ­Ø¯ÙŠØ«Ø§Øª Ø°ÙƒÙŠØ©
        const UPDATE_INTERVAL_MS = 5 * 60 * 1000; // ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        let schedulerId = null;

        // â€”â€”â€”â€”â€” ÙˆØ¸Ø§Ø¦Ù Ø£Ø³Ø§Ø³ÙŠØ© â€”â€”â€”â€”â€”
        function initializeFirebase(){ try { if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); storage = firebase.storage(); logDebug('success','âœ“ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase'); initCache(); return true; } catch(e){ logDebug('error',`âœ— Ø®Ø·Ø£ Firebase: ${e.message}`); showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error'); return false; } }

        function login(){ const password = document.getElementById('adminPass').value; if(password === adminPassword){ isLoggedIn = true; document.getElementById('loginContainer').style.display='none'; document.getElementById('adminPanel').style.display='block'; loadData(); showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­','success'); logAudit('login','ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­'); updateSystemStatus(); startSmartScheduler(); } else { showNotification('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','error'); logDebug('error','âœ— Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'); logAudit('login_failed','Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø®Ø§Ø·Ø¦Ø©'); }}

        function logout(){ isLoggedIn=false; document.getElementById('loginContainer').style.display='flex'; document.getElementById('adminPanel').style.display='none'; document.getElementById('adminPass').value=''; debugMode=false; document.querySelector('.debug-toggle').classList.remove('active'); document.getElementById('debugPanel').classList.remove('show'); logAudit('logout','ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬'); }

        // â€”â€”â€”â€”â€” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª â€”â€”â€”â€”â€”
        function showNotification(text,type='success'){ const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=text; document.body.appendChild(n); requestAnimationFrame(()=>n.classList.add('show')); setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(),300); }, 3000); }

        // â€”â€”â€”â€”â€” Ø§Ù„ÙƒØ§Ø´ â€”â€”â€”â€”â€”
        function initCache(){ cleanupExpiredCache(); updateCacheStats(); logDebug('success','âœ“ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ø´'); }
        function cleanupExpiredCache(){ const now=Date.now(); let cleaned=0; for(let i=localStorage.length-1;i>=0;i--){ const key=localStorage.key(i); if(key && key.startsWith(CACHE_PREFIX)){ try{ const item=JSON.parse(localStorage.getItem(key)); if(item && item.expiry && now>item.expiry){ localStorage.removeItem(key); cleaned++; } }catch{ localStorage.removeItem(key); cleaned++; } } } if(cleaned>0){ logDebug('success',`ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ${cleaned} Ø¹Ù†ØµØ± Ù…Ù†ØªÙ‡ÙŠ`); } cacheStats.lastCleanup=now; }
        function setCache(key,data,dur=CACHE_DURATION){ try{ const item={ data, timestamp:Date.now(), expiry:Date.now()+dur }; localStorage.setItem(CACHE_PREFIX+key, JSON.stringify(item)); updateCacheStats(); logDebug('success',`ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´: ${key}`); }catch(e){ logDebug('error',`âœ— Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´: ${e.message}`); if(e.name==='QuotaExceededError'){ cleanupExpiredCache(); } } }
        function getCache(key){ try{ const item=localStorage.getItem(CACHE_PREFIX+key); if(!item){ cacheStats.misses++; return null; } const parsed=JSON.parse(item); if(Date.now()>parsed.expiry){ localStorage.removeItem(CACHE_PREFIX+key); cacheStats.misses++; return null; } cacheStats.hits++; incrementCacheHit(); return parsed.data; }catch{ cacheStats.misses++; return null; } }
        function updateCacheStats(){ let size=0; for(let i=0;i<localStorage.length;i++){ const key=localStorage.key(i); if(key && key.startsWith(CACHE_PREFIX)) size++; } cacheStats.size=size; }
        function clearCache(){ if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø´ØŸ')) return; let cleared=0; for(let i=localStorage.length-1;i>=0;i--){ const key=localStorage.key(i); if(key && key.startsWith(CACHE_PREFIX)){ localStorage.removeItem(key); cleared++; } } cacheStats={ size:0, hits:0, misses:0, lastCleanup:Date.now() }; updateCacheStats(); logDebug('warning',`ğŸ—‘ ØªÙ… Ù…Ø³Ø­ ${cleared} Ø¹Ù†ØµØ± ÙƒØ§Ø´`); showNotification(`ØªÙ… Ù…Ø³Ø­ ${cleared} Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ÙƒØ§Ø´`,'success'); if(debugMode) updateCacheStatusDisplay(); logAudit('cache_clear',`Ù…Ø³Ø­ ${cleared} Ø¹Ù†ØµØ±`); }

        // â€”â€”â€”â€”â€” Debug & Monitor â€”â€”â€”â€”â€”
        function toggleDebug(){ debugMode=!debugMode; const t=document.querySelector('.debug-toggle'); const p=document.getElementById('debugPanel'); if(debugMode){ t.classList.add('active'); p.classList.add('show'); logDebug('success','âœ“ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­'); updateSystemStatus(); updateApiMonitor(); updateCacheStatusDisplay(); if(!window.debugInterval){ window.debugInterval=setInterval(()=>{ if(debugMode){ updateSystemStatus(); updateApiMonitor(); updateCacheStatusDisplay(); renderPriorityPreview(); } else { clearInterval(window.debugInterval); window.debugInterval=null; } }, 3000); } } else { t.classList.remove('active'); p.classList.remove('show'); logDebug('warning','âš  Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­'); if(window.debugInterval){ clearInterval(window.debugInterval); window.debugInterval=null; } } }
        function logDebug(type,message){ const timestamp=new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); const entry={type,message,timestamp,id:Date.now()}; debugMessages.unshift(entry); if(debugMessages.length>100) debugMessages=debugMessages.slice(0,100); if(debugMode) updateDebugLog(); console.log(`[DEBUG ${timestamp}] ${message}`); }
        function updateDebugLog(){ const el=document.getElementById('debugLog'); if(!el) return; el.innerHTML = debugMessages.slice(0,20).map(e=>`<div class="debug-${e.type}">[${e.timestamp}] ${e.message}</div>`).join(''); }
        function updateApiMonitor(){ if(!debugMode) return; const now=Date.now(); if(now-lastApiReset>3600000){ apiCallCount=0; lastApiReset=now; logDebug('success','ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ API (Ø³Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©)'); }
            const remaining=Math.max(0, 1000 - apiCallCount); const hitRate= totalRequests>0 ? Math.round((cacheHits/totalRequests)*100) : 0;
            document.getElementById('apiCallsCount').textContent=apiCallCount; document.getElementById('apiQuotaRemaining').textContent=remaining; document.getElementById('cacheHitRate').textContent= hitRate + '%'; document.getElementById('cacheSizeDisplay').textContent=cacheStats.size;
            const warningDiv=document.getElementById('apiQuotaWarning'); warningDiv.innerHTML='';
            document.getElementById('savingModeBadge').style.display = (apiCallCount>900) ? 'inline-flex' : 'none';
            if(apiCallCount>900){ warningDiv.innerHTML='<div class="api-quota-danger"><i class="fas fa-exclamation-triangle"></i> ÙˆØ´Ùƒ Ù†ÙØ§Ø¯ Ø­ØµØ© API! Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©.</div>'; disableApiFeatures(true); }
            else if(apiCallCount>800){ warningDiv.innerHTML='<div class="api-quota-warning"><i class="fas fa-exclamation-circle"></i> Ø­ØµØ© API Ù…Ù†Ø®ÙØ¶Ø© â€“ ÙŠÙÙØ¶Ù‘Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø´ ÙˆÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙÙŠØ±.</div>'; disableApiFeatures(false); }
            else { disableApiFeatures(false); }
        }
        function disableApiFeatures(disable){ const r=document.getElementById('refreshBtn'); const o=document.getElementById('optimizeBtn'); if(r){ r.disabled=disable; r.title=disable?'Ù…Ø¹Ø·Ù„ - Ø­ØµØ© API Ù…Ù†Ø®ÙØ¶Ø©':'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'; } if(o){ o.disabled=disable; o.title=disable?'Ù…Ø¹Ø·Ù„ - Ø­ØµØ© API Ù…Ù†Ø®ÙØ¶Ø©':'ØªØ­Ø³ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ'; } }
        function incrementApiCall(amount=1){ apiCallCount += amount; totalRequests++; logDebug('warning',`ğŸ“¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… API: +${amount} (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${apiCallCount}/1000)`); if(debugMode) updateApiMonitor(); if(apiCallCount>800 && apiCallCount<=800+amount){ showNotification('ØªØ­Ø°ÙŠØ±: Ø­ØµØ© YouTube API Ù…Ù†Ø®ÙØ¶Ø©!','warning'); logDebug('error','âš  Ø­ØµØ© API Ù…Ù†Ø®ÙØ¶Ø©'); } }
        function incrementCacheHit(){ cacheHits++; totalRequests++; if(debugMode) updateApiMonitor(); }

        // â€”â€”â€”â€”â€” Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ â€”â€”â€”â€”â€”
        async function loadData(){ if(!isLoggedIn) return; try{ initializeFirebase(); await Promise.all([ loadRequests(), loadChannelsWithCache(), loadKey(), loadSiteSettings(), loadContactSettings() ]); updateStats(); logDebug('success','âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); } catch(e){ logDebug('error',`âœ— Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`); showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error'); } }

        // â€”â€”â€”â€”â€” Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¹Ø§Ù…Ø© â€”â€”â€”â€”â€” (Ø§Ø®ØªØµØ§Ø±Ù‹Ø§)
        function updateStats(){ const c=channels.length; const live=channels.filter(x=>x.status==='live').length; const stats=document.getElementById('statsOverview'); stats.innerHTML = `
            <div class="stat-card"><div class="stat-icon requests"><i class="fas fa-plug"></i></div><div class="stat-number">${apiCallCount}</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª API</div></div>
            <div class="stat-card"><div class="stat-icon channels"><i class="fas fa-tv"></i></div><div class="stat-number">${c}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</div></div>
            <div class="stat-card"><div class="stat-icon live"><i class="fas fa-broadcast-tower"></i></div><div class="stat-number">${live}</div><div class="stat-label">Ù‚Ù†ÙˆØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©</div></div>
            <div class="stat-card"><div class="stat-icon api-status"><i class="fas fa-signal"></i></div><div class="stat-number">${Math.max(0,1000-apiCallCount)}</div><div class="stat-label">Ø­ØµØ© Ù…ØªØ¨Ù‚ÙŠØ©</div></div>`;
        }

        // â€”â€”â€”â€”â€” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª (Ù…Ø¹ ÙƒØ§Ø´) â€”â€”â€”â€”â€”
        async function loadChannelsWithCache(){ const loading=document.getElementById('channelsLoading'); const list=document.getElementById('channels'); loading.style.display='block'; list.innerHTML=''; try{
                const cached=getCache('channels_list'); if(cached){ channels=cached; renderChannels(); loading.style.display='none'; logDebug('success',`âœ“ ØªØ­Ù…ÙŠÙ„ ${channels.length} Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´`); return; }
                const snapshot = await db.collection('channels').orderBy('order','asc').get(); channels=[]; if(snapshot.empty){ list.innerHTML = `<div class='loading'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª</div>`; } else { snapshot.forEach(doc=>{ channels.push({ id:doc.id, ...doc.data() }); }); setCache('channels_list', channels); renderChannels(); }
            } catch(e){ list.innerHTML = `<div class='loading'><i class='fas fa-exclamation-triangle'></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>`; logDebug('error',`âœ— Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: ${e.message}`); } finally { loading.style.display='none'; } }

        function renderChannels(){ const container=document.getElementById('channels'); container.innerHTML=''; channels.forEach((channel,index)=>{ const displayName = channel.title || channel.name || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'; const addedDate = channel.addedAt && channel.addedAt.toDate ? formatDate(channel.addedAt.toDate()) : (channel.addedAt? formatDate(new Date(channel.addedAt)) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'); const isCached = !!getCache(`channel_${channel.id}`);
            const el=document.createElement('div'); el.className=`item-card ${isCached?'cached':''}`; el.draggable=true; el.dataset.channelId=channel.id; el.dataset.order=channel.order||index;
            el.innerHTML = `
                <div class='drag-handle'><i class='fas fa-grip-vertical'></i></div>
                <div class='item-header'>
                    <div class='item-info'>
                        <div class='item-name'>${displayName}</div>
                        ${channel.url ? `<a href='${channel.url}' target='_blank' class='item-url'><i class='fas fa-external-link-alt'></i> ${channel.url}</a>` : ''}
                        <div class='item-timestamp'><i class='fas fa-calendar-plus'></i> ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§: ${addedDate}</div>
                        <div class='item-status status-${channel.status || 'offline'}'>${getStatusText(channel.status)}</div>
                        ${channel.priorityScore!==undefined? `<div style='margin-top:6px;font-size:.85rem;color:#4f46e5'><i class='fas fa-bolt'></i> Ø£ÙˆÙ„ÙˆÙŠØ©: ${channel.priorityScore}</div>`: ''}
                        ${isCached ? `<div style='color:#9b59b6;font-size:.8rem;margin-top:5px;'><i class='fas fa-database'></i> Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ø´</div>`: ''}
                    </div>
                </div>
                <div class='item-actions'>
                    <select class='status-selector' onchange="updateStatus('${channel.id}', this.value)">
                        <option value='offline' ${channel.status==='offline' || !channel.status ? 'selected':''}>ØºÙŠØ± Ù…ØªØ§Ø­</option>
                        <option value='live' ${channel.status==='live' ? 'selected':''}>Ù…Ø¨Ø§Ø´Ø±</option>
                        <option value='upcoming' ${channel.status==='upcoming' ? 'selected':''}>Ù‚Ø±ÙŠØ¨Ù‹Ø§</option>
                    </select>
                    <button class='btn btn-delete' onclick="deleteChannel('${channel.id}')"><i class='fas fa-trash'></i> Ø­Ø°Ù</button>
                </div>`;
            el.addEventListener('dragstart', handleDragStart); el.addEventListener('dragover', handleDragOver); el.addEventListener('drop', handleDrop); el.addEventListener('dragend', handleDragEnd);
            container.appendChild(el);
        }); renderPriorityPreview(); }

        function getStatusText(st){ return st==='live'?'Ù…Ø¨Ø§Ø´Ø±': st==='upcoming'?'Ù‚Ø±ÙŠØ¨Ù‹Ø§': st==='error'?'Ø®Ø·Ø£':'ØºÙŠØ± Ù…ØªØ§Ø­'; }
        function formatDate(d){ try{ return new Date(d).toLocaleString('ar-SA',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }catch{ return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; } }

        // â€”â€”â€”â€”â€”â€” ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ© â€”â€”â€”â€”â€”â€”
        function parseSmartInput(input){ input=input.trim(); if(!input) return null;
            // 1) Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„
            if(/^https?:\/\/([^\s]+)$/.test(input)){
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù†: /channel/UC.. | /@handle | /c/name | /user/name
                const patterns=[
                    { regex:/youtube\.com\/channel\/([a-zA-Z0-9_-]+)/, type:'channel_id' },
                    { regex:/youtube\.com\/@([a-zA-Z0-9_.-]+)/, type:'handle' },
                    { regex:/youtube\.com\/c\/([a-zA-Z0-9_-]+)/, type:'custom_url' },
                    { regex:/youtube\.com\/user\/([a-zA-Z0-9_-]+)/, type:'username' }
                ];
                for(const p of patterns){ const m=input.match(p.regex); if(m) return { type:p.type, value:m[1], original:input } }
                return { type:'url', value:input, original:input };
            }
            // 2) @Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if(/^@/.test(input)){ return { type:'handle', value: input.replace(/^@/,''), original:input }; }
            // 3) Ù…Ø¹Ø±Ù Ù‚Ù†Ø§Ø© UCxxxx
            if(/^UC[\w-]{10,}$/.test(input)){ return { type:'channel_id', value: input, original:input }; }
            // 4) Ø§Ø³Ù… Ù…Ø®ØµØµ â€” Ø³Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡ Ø¹Ù†Ø¯ ØªÙˆÙØ± API
            return { type:'custom_name', value: input, original:input };
        }

        async function addSmartChannel(){ const raw=document.getElementById('smartChannelInput').value; const parsed=parseSmartInput(raw);
            if(!parsed){ showNotification('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø©','error'); return; }
            const apiKey = await getApiKey();
            const savingMode = apiCallCount>900 || !apiKey; // ÙˆØ¶Ø¹ ØªÙˆÙÙŠØ±
            try{
                // Ù†Ø­Ø§ÙˆÙ„ ØªÙˆÙ„ÙŠØ¯ URL Ù‚ÙŠØ§Ø³ÙŠ Ø¥Ù† Ø£Ù…ÙƒÙ†
                let url = null; if(parsed.type==='channel_id'){ url = `https://www.youtube.com/channel/${parsed.value}`; }
                else if(parsed.type==='handle'){ url = `https://www.youtube.com/@${parsed.value}`; }
                else if(parsed.type==='custom_url'){ url = `https://www.youtube.com/c/${parsed.value}`; }
                else if(parsed.type==='username'){ url = `https://www.youtube.com/user/${parsed.value}`; }
                else if(parsed.type==='url'){ url = parsed.value; }

                // Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ÙŠØ© Ø¥Ù„Ù‰ Firestore
                const maxOrder = Math.max(...channels.map(c=>c.order||0), 0);
                const baseDoc = { name: parsed.value, url, status:'offline', order:maxOrder+1, addedAt:new Date(), needsUpdate: savingMode, sourceType: parsed.type };
                const docRef = await db.collection('channels').add(baseDoc);
                const newChannel = { id:docRef.id, ...baseDoc };
                channels.push(newChannel); setCache('channels_list', channels); renderChannels(); updateStats();
                showNotification('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© (ØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ)','success'); logDebug('success',`âœ“ Ø¥Ø¶Ø§ÙØ© Ø°ÙƒÙŠØ©: ${parsed.type} = ${parsed.value}`); logAudit('add',`Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© (${parsed.type})`, { id:docRef.id, value:parsed.value });

                // Ø¥Ø°Ø§ Ù„Ø³Ù†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙÙŠØ±ØŒ Ù†Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¢Ù†
                if(!savingMode && apiKey){ setTimeout(async ()=>{ try{ await updateChannelFromInput(newChannel, parsed, apiKey); renderChannels(); } catch(e){ logDebug('error',`âœ— ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©: ${e.message}`); } }, 300); }
            } catch(e){ showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©','error'); logDebug('error',`âœ— Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø°ÙƒÙŠØ©: ${e.message}`); }
        }

        async function updateChannelFromInput(channel, parsed, apiKey){
            const cacheKey = `channel_${channel.id}`; const cached=getCache(cacheKey); if(cached && cached.title){ return cached; }
            incrementApiCall(3);
            let apiUrl=null;
            if(parsed.type==='channel_id'){
                apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${parsed.value}&key=${apiKey}`;
            } else {
                // Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø©
                const q = encodeURIComponent(parsed.value);
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${q}&key=${apiKey}&maxResults=1`;
                const sRes = await fetch(searchUrl); const sData = await sRes.json();
                if(sData.items && sData.items.length>0){ const channelId = (sData.items[0].snippet.channelId) || (sData.items[0].id && sData.items[0].id.channelId); if(channelId){ apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${apiKey}`; } }
            }
            if(!apiUrl) return null; const res = await fetch(apiUrl); const data = await res.json(); if(data.items && data.items.length>0){ const ch = data.items[0]; const model = { title: ch.snippet.title, thumbnail: (ch.snippet.thumbnails && (ch.snippet.thumbnails.medium?.url || ch.snippet.thumbnails.default?.url)) };
                await db.collection('channels').doc(channel.id).update({ title:model.title, thumbnail:model.thumbnail, needsUpdate:false, lastUpdated:new Date() });
                setCache(cacheKey, model); logDebug('success',`âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©: ${model.title}`); return model; }
            return null;
        }

        // Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª â€” ØªØ³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
        function extractChannelId(url){ if(!url) return null; const patterns=[ {regex:/youtube\.com\/channel\/([a-zA-Z0-9_-]+)/, type:'channel_id'}, {regex:/youtube\.com\/c\/([a-zA-Z0-9_-]+)/, type:'custom_url'}, {regex:/youtube\.com\/@([a-zA-Z0-9_.-]+)/, type:'handle'}, {regex:/youtube\.com\/user\/([a-zA-Z0-9_-]+)/, type:'username'} ]; for(let p of patterns){ const m=url.match(p.regex); if(m) return { value:m[1], type:p.type, isChannelId: p.type==='channel_id' }; } return null; }

        async function updateChannelFromAPI(channel, apiKey){ try{ const info = channel.url ? extractChannelId(channel.url) : (channel.sourceType? {value:channel.name, type:channel.sourceType, isChannelId: channel.sourceType==='channel_id'} : null); if(!info){ logDebug('warning',`âš  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©: ${channel.url||channel.name}`); return; }
                const cacheKey=`channel_${channel.id}`; const cached=getCache(cacheKey); if(cached){ return cached; }
                incrementApiCall(3);
                let apiUrl; if(info.isChannelId){ apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${info.value}&key=${apiKey}`; } else { const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${info.value}&key=${apiKey}&maxResults=1`; const s=await fetch(searchUrl); const sd=await s.json(); if(sd.items && sd.items.length>0){ const channelId = (sd.items[0].snippet.channelId) || (sd.items[0].id && sd.items[0].id.channelId); if(channelId){ apiUrl=`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${apiKey}`; } else { return; } } else { return; } }
                const r=await fetch(apiUrl); const data=await r.json(); if(data.items && data.items.length>0){ const ch=data.items[0]; const model={ title:ch.snippet.title, thumbnail:ch.snippet.thumbnails?.medium?.url }; await db.collection('channels').doc(channel.id).update({ title:model.title, thumbnail:model.thumbnail, lastUpdated:new Date(), needsUpdate:false }); setCache(cacheKey, model); return model; }
            } catch(e){ logDebug('error',`âœ— Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ« Ù‚Ù†Ø§Ø©: ${e.message}`); throw e; } }

        // â€”â€”â€”â€”â€” Ø§Ù„ØªØ­Ø¯ÙŠØ«/Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ â€”â€”â€”â€”â€”
        function computePriorityScore(channel){ // Ù…Ø¨Ø§Ø´Ø± > Ù‚Ø±ÙŠØ¨Ù‹Ø§ > ØºÙŠØ± Ù…ØªØ§Ø­ØŒ ÙˆØ­Ø¯Ø§Ø«Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const statusScore = channel.status==='live' ? 100 : channel.status==='upcoming' ? 70 : 10;
            const last = channel.lastUpdated ? new Date(channel.lastUpdated.seconds? channel.lastUpdated.seconds*1000 : channel.lastUpdated) : null;
            const freshness = last ? Math.max(0, 50 - Math.floor((Date.now() - last.getTime())/60000)) : 25; // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ‚Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·
            const needs = channel.needsUpdate ? 30 : 0;
            return statusScore + freshness + needs;
        }
        function annotatePriorities(){ channels = channels.map(c=>({ ...c, priorityScore: computePriorityScore(c) })); channels.sort((a,b)=> (b.priorityScore||0) - (a.priorityScore||0)); }
        async function optimizeChannels(){ const apiKey = await getApiKey(); if(!apiKey){ showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ YouTube API','error'); return; } annotatePriorities(); let optimized=0, errors=0; for(const ch of channels){ if(apiCallCount>950) break; try{ await updateChannelFromAPI(ch, apiKey); optimized++; await new Promise(r=>setTimeout(r,120)); } catch{ errors++; } } showNotification(`ØªÙ… ØªØ­Ø³ÙŠÙ† ${optimized} Ù‚Ù†Ø§Ø©${errors?` (${errors} Ø®Ø·Ø£)`:''}`,(optimized?'success':'warning')); setCache('channels_list', channels); await loadChannelsWithCache(); logAudit('optimize',`ØªØ­Ø³ÙŠÙ† ${optimized} Ù‚Ù†Ø§Ø©`); }
        async function refreshChannelData(){ const apiKey = await getApiKey(); if(!apiKey){ showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ YouTube API','error'); return; } annotatePriorities(); let updated=0, fromCache=0; for(const ch of channels){ if(apiCallCount>950) break; const cached=getCache(`channel_${ch.id}`); if(cached){ fromCache++; continue; } try{ await updateChannelFromAPI(ch, apiKey); updated++; await new Promise(r=>setTimeout(r,150)); } catch{} } setCache('channels_list', channels); showNotification(`ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${updated} Ù…Ù† APIØŒ ${fromCache} Ù…Ù† Ø§Ù„ÙƒØ§Ø´`,'success'); await loadChannelsWithCache(); logAudit('refresh',`ØªØ­Ø¯ÙŠØ« ${updated} Ù‚Ù†Ø§Ø© (Ù…Ù† Ø§Ù„ÙƒØ§Ø´ ${fromCache})`); }
        function startSmartScheduler(){ if(schedulerId) clearInterval(schedulerId); schedulerId = setInterval(async ()=>{ try{ const apiKey = await getApiKey(); if(!apiKey) return; annotatePriorities(); const top = channels.slice(0, Math.max(3, Math.floor(channels.length*0.1))); // Ù†Ø­Ø¯Ù‘Ø« Ø£Ø¹Ù„Ù‰ 10% Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 3
                    for(const ch of top){ if(apiCallCount>950) break; await updateChannelFromAPI(ch, apiKey); await new Promise(r=>setTimeout(r,150)); }
                    logDebug('success',`â± ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ø¯ÙˆÙ„ (${top.length}) Ù‚Ù†Ø§Ø©`); if(debugMode) renderPriorityPreview(); setCache('channels_list', channels);
                } catch(e){ logDebug('error',`âœ— Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„: ${e.message}`); }
            }, UPDATE_INTERVAL_MS);
        }
        function renderPriorityPreview(){ if(!debugMode) return; const prev=document.getElementById('priorityPreview'); if(!prev) return; const sample = [...channels].sort((a,b)=> (b.priorityScore||0)-(a.priorityScore||0)).slice(0,8).map(c=>`<li>${(c.title||c.name||'Ù‚Ù†Ø§Ø©')} â€” <b>${c.priorityScore||computePriorityScore(c)}</b></li>`).join(''); prev.innerHTML = `<div class='debug-title'><i class='fas fa-bolt'></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</div><ul style='padding-right:18px; line-height:1.7;'>${sample||'<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª</li>'}</ul>`; }

        // â€”â€”â€”â€”â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù…Ø®ØªØµØ±Ø©) â€”â€”â€”â€”â€”
        async function loadRequests(){ const loading=document.getElementById('requestsLoading'); const box=document.getElementById('requests'); loading.style.display='block'; box.innerHTML=''; try{ const snapshot = await db.collection('requests').orderBy('timestamp','desc').get(); requests=[]; if(snapshot.empty){ box.innerHTML = `<div class='loading'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`; } else { snapshot.forEach(doc=>requests.push({ id:doc.id, ...doc.data() })); box.innerHTML = requests.map(r=>`<div class='item-card'><div class='item-name'><i class='fas fa-user-plus'></i> Ø·Ù„Ø¨: ${r.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div><div class='item-timestamp'>${r.timestamp? formatDate(r.timestamp.toDate ? r.timestamp.toDate(): r.timestamp):''}</div></div>`).join(''); } } catch(e){ box.innerHTML = `<div class='loading'><i class='fas fa-exclamation-triangle'></i> Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`; } finally { loading.style.display='none'; } }

        // â€”â€”â€”â€”â€” ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ø­Ø°Ù â€”â€”â€”â€”â€”
        async function updateStatus(id, value){ try{ await db.collection('channels').doc(id).update({ status:value, lastUpdated:new Date() }); const ch = channels.find(c=>c.id===id); if(ch){ ch.status=value; ch.lastUpdated=new Date(); } renderChannels(); logAudit('edit',`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‚Ù†Ø§Ø© Ø¥Ù„Ù‰ ${value}`, {id}); } catch(e){ showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©','error'); } }
        async function deleteChannel(id){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø©ØŸ')) return; try{ await db.collection('channels').doc(id).delete(); channels = channels.filter(c=>c.id!==id); setCache('channels_list', channels); renderChannels(); updateStats(); showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù','success'); logAudit('delete','Ø­Ø°Ù Ù‚Ù†Ø§Ø©',{id}); } catch(e){ showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù','error'); }
        }

        // â€”â€”â€”â€”â€” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© (Ø§Ø®ØªØµØ§Ø±Ù‹Ø§) â€”â€”â€”â€”â€”
        async function loadKey(){ const snap = await db.collection('settings').doc('youtube').get(); const data = snap.exists? snap.data(): {}; if(data.key) document.getElementById('ytKey').value=data.key; }
        async function saveKey(){ const key=document.getElementById('ytKey').value.trim(); await db.collection('settings').doc('youtube').set({ key }, { merge:true }); showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­','success'); logAudit('edit','ØªØ­Ø¯ÙŠØ« Ù…ÙØªØ§Ø­ API'); }
        async function getApiKey(){ const el=document.getElementById('ytKey'); return el && el.value.trim() ? el.value.trim() : null; }
        async function saveSiteSettings(){ const name=document.getElementById('siteName').value; const desc=document.getElementById('siteDescription').value; await db.collection('settings').doc('site').set({ name, desc }, { merge:true }); showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','success'); logAudit('edit','ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹'); }
        async function loadSiteSettings(){ const snap=await db.collection('settings').doc('site').get(); if(snap.exists){ const d=snap.data(); document.getElementById('siteName').value=d.name||''; document.getElementById('siteDescription').value=d.desc||''; } }
        async function saveContactSettings(){ const email=document.getElementById('contactEmail').value; await db.collection('settings').doc('contact').set({ email }, { merge:true }); showNotification('ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„','success'); logAudit('edit','ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„'); }
        async function loadContactSettings(){ const snap=await db.collection('settings').doc('contact').get(); if(snap.exists){ const d=snap.data(); document.getElementById('contactEmail').value=d.email||''; } }
        function handleLogoUpload(input){ const file=input.files && input.files[0]; if(!file) return; showNotification('Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±â€¦','success'); logAudit('edit','Ø±ÙØ¹ Ø´Ø¹Ø§Ø±'); }

        // â€”â€”â€”â€”â€” Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„ØªØ±ØªÙŠØ¨ â€”â€”â€”â€”â€”
        function handleDragStart(e){ draggedElement = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; }
        function handleDragOver(e){ e.preventDefault(); const target = this; if(target && target!==draggedElement){ const parent = target.parentNode; const draggedIndex = Array.from(parent.children).indexOf(draggedElement); const targetIndex = Array.from(parent.children).indexOf(target); if(draggedIndex < targetIndex){ parent.insertBefore(draggedElement, target.nextSibling); } else { parent.insertBefore(draggedElement, target); } }
        }
        async function handleDrop(){ this.classList.remove('dragover'); await persistOrder(); }
        function handleDragEnd(){ this.classList.remove('dragging'); }
        async function persistOrder(){ const container=document.getElementById('channels'); const cards=Array.from(container.children); for(let i=0;i<cards.length;i++){ const id=cards[i].dataset.channelId; await db.collection('channels').doc(id).update({ order:i }); const ch=channels.find(c=>c.id===id); if(ch) ch.order=i; } setCache('channels_list', channels); showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨','success'); logAudit('edit','Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª'); }

        // â€”â€”â€”â€”â€” Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· â€”â€”â€”â€”â€”
        async function logAudit(type, message, extra={}){ try{ const payload = { type, message, extra, ts:new Date(), user:'admin' }; await db.collection('audit').add(payload); if(debugMode){ debugMessages.unshift({ type:'success', message:`[AUDIT] ${type}: ${message}`, timestamp:new Date().toLocaleTimeString('ar-SA') }); updateDebugLog(); } } catch(e){ console.warn('Audit log write failed', e); } }
        function openAuditFull(){ document.getElementById('auditFull').style.display='flex'; loadAuditTable(); }
        function closeAuditFull(){ document.getElementById('auditFull').style.display='none'; }
        async function loadAuditTable(){ const body=document.getElementById('auditTableBody'); body.innerHTML=''; const snap = await db.collection('audit').orderBy('ts','desc').limit(500).get(); const rows=[]; let currentDate=null; snap.forEach(doc=>{ const a=doc.data(); const d=new Date(a.ts.seconds? a.ts.seconds*1000 : a.ts); const dateKey = d.toLocaleDateString('ar-SA'); if(dateKey!==currentDate){ currentDate = dateKey; rows.push(`<tr><td colspan='4'><span class='group-date'>${dateKey}</span></td></tr>`); }
                const badge = a.type==='add'?'b-add': a.type==='delete'?'b-del': a.type==='edit'?'b-edit': a.type==='login'||a.type==='logout'?'b-login': a.type==='clear_audit'?'b-clear':'b-edit';
                rows.push(`<tr><td><span class='badge ${badge}'>${a.type}</span> ${a.message||''}</td><td>${a.extra && Object.keys(a.extra).length ? `<code>${escapeHtml(JSON.stringify(a.extra))}</code>`:''}</td><td>${a.user||''}</td><td>${d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</td></tr>`);
            }); body.innerHTML = rows.join(''); }
        async function exportAuditJSON(){ const snap = await db.collection('audit').orderBy('ts','desc').limit(1000).get(); const data=[]; snap.forEach(doc=> data.push({ id:doc.id, ...doc.data() })); const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`audit-${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø¨ØµÙŠØºØ© JSON','success'); }
        function confirmClearAudit(){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.')) return; clearAudit(); }
        async function clearAudit(){ // Ù†Ø­ÙØ¸ Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­ Ø«Ù… Ù†Ø¨Ø¯Ø£ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
            await db.collection('audit').add({ type:'clear_audit', message:'Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', ts:new Date(), user:'admin' });
            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø› ÙŠÙ…ÙƒÙ†Ù†Ø§ ÙˆØ³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø³Ù†Ø­Ø°Ù Ø¢Ø®Ø± 1000 Ø¹Ù†ØµØ±
            const snap = await db.collection('audit').limit(1000).get(); const batch = db.batch(); snap.forEach(doc=> batch.delete(doc.ref)); await batch.commit(); showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„','success'); loadAuditTable(); }
        function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;"}[m])); }

        // â€”â€”â€”â€”â€” Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© â€”â€”â€”â€”â€”
        function toggleQuickAdd(){ const el=document.getElementById('quickAddForm'); el.style.display = el.style.display==='none' ? 'block':'none'; }
        function updateSystemStatus(){ const sys=document.getElementById('systemStatus'); if(!sys) return; const remaining=Math.max(0,1000-apiCallCount); sys.innerHTML = `Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: ${channels.length} | Ø­ØµØ© API Ù…ØªØ¨Ù‚ÙŠØ©: ${remaining} | Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ø´: ${cacheStats.size}`; }
        function updateCacheStatusDisplay(){ const el=document.getElementById('cacheStatus'); if(!el) return; el.innerHTML = `Ø§Ù„Ø­Ø¬Ù…: ${cacheStats.size} | hits: ${cacheStats.hits} | misses: ${cacheStats.misses}`; }

        // â€”â€”â€”â€”â€” Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© Ù‚Ø¯ÙŠÙ…Ø© â€”â€”â€”â€”â€”
        async function addChannelQuick(){ const name=document.getElementById('quickChannelName').value.trim(); if(!name) return; const doc= await db.collection('channels').add({ name, status:'offline', order:(channels.length? (Math.max(...channels.map(c=>c.order||0))+1):1), addedAt:new Date(), needsUpdate:true, sourceType:'custom_name' }); channels.push({ id:doc.id, name, status:'offline', needsUpdate:true, sourceType:'custom_name' }); setCache('channels_list', channels); renderChannels(); updateStats(); showNotification('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©','success'); logAudit('add','Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© (Ø³Ø±ÙŠØ¹Ø©)', {id:doc.id, name}); }

        // â€”â€”â€”â€”â€” Ø§Ø®ØªØ¨Ø§Ø± API â€”â€”â€”â€”â€”
        async function testYouTubeAPI(){ const key=await getApiKey(); if(!key){ showNotification('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ù‹Ø§','error'); return; } try{ incrementApiCall(); const res = await fetch(`https://www.googleapis.com/youtube/v3/i18nLanguages?part=snippet&key=${key}`); const data = await res.json(); if(data && !data.error){ showNotification('Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± API','success'); logDebug('success','âœ“ Ø§Ø®ØªØ¨Ø§Ø± API Ù†Ø§Ø¬Ø­'); } else { throw new Error(data.error?.message||'ÙØ´Ù„'); } } catch(e){ showNotification('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± API','error'); logDebug('error',`âœ— Ø§Ø®ØªØ¨Ø§Ø± API: ${e.message}`); } }

        // â€”â€”â€”â€”â€” Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© DOM â€”â€”â€”â€”â€”
        document.addEventListener('DOMContentLoaded', ()=>{ /* Ø¨Ù‚Ø§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­ØªÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */ });
    </script>
</body>
</html>
