// دوال سجل النشاط الإضافية
        async function exportAuditLog() {
            try {
                const exportData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        totalEntries: auditLog.length,
                        sessionId: window.sessionId,
                        version: '2.0'
                    },
                    entries: auditLog.map(entry => ({
                        ...entry,
                        timestamp: entry.timestamp.toISOString ? entry.timestamp.toISOString() : entry.timestamp
                    }))
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit-log-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addAuditEntry('تصدير سجل النشاط', `تم تصدير ${auditLog.length} حدث`);
                showNotification('تم تصدير سجل النشاط', 'success');
                logDebug('success', '📊 تم تصدير سجل النشاط');
            } catch (error) {
                console.error('خطأ في تص        // النظام الذكي لإدارة الـ API
        function initSmartApiSystem() {
            // حساب أولويات القنوات
            calculateChannelPriorities();
            
            // جدولة التحديثات الذكية
            if (smartApiEnabled && apiCallCount < 950) {
                scheduleSmartUpdates();
            }
            
            logDebug('success', '🧠 تم تفعيل النظام الذكي لإدارة API');
        }
        
        function calculateChannelPriorities() {
            channelPriorities.clear();
            
            channels.forEach(channel => {
                let priority = 0;
                
                // أولوية حسب الحالة
                if (channel.status === 'live') priority += 100;
                else if (channel.status === 'upcoming') priority += 50;
                
                // أولوية للقنوات التي تحتاج تحديث
                if (channel.needsApiUpdate) priority += 30;
                
                // أولوية حسب آخر تحديث
                if (channel.lastUpdated) {
                    const daysSinceUpdate = (Date.now() - channel.lastUpdated.toDate().getTime()) / (1000 * 60 * 60 * 24);
                    if (daysSinceUpdate > 1) priority += Math.min(daysSinceUpdate * 5, 25);
                }
                
                // أولوية للقنوات الشائعة
                if (channel.subscriberCount) {
                    const subs = parseInt(channel.subscriberCount);
                    if (subs > 1000000) priority += 20; // مليون+
                    else if (subs > 100000) priority += 10; // 100K+
                    else if (subs > 10000) priority += 5; // 10K+
                }
                
                channelPriorities.set(channel.id, priority);
            });
            
            logDebug('success', `🎯 تم حساب أولويات ${channelPriorities.size} قناة`);
        }
        
        async function scheduleSmartUpdates() {
            if (apiCallCount > 900) {
                logDebug('warning', '⚠ تم إيقاف التحديثات الذكية - حصة API منخفضة');
                return;
            }
            
            // ترتيب القنوات حسب الأولوية
            const sortedChannels = [...channels].sort((a, b) => {
                return (channelPriorities.get(b.id) || 0) - (channelPriorities.get(a.id) || 0);
            });
            
            // تحديث أهم 5-10 قنوات
            const channelsToUpdate = sortedChannels.slice(0, Math.min(10, Math.floor((1000 - apiCallCount) / 5)));
            
            if (channelsToUpdate.length > 0) {
                logDebug('success', `🔄 جدولة تحديث ذكي لـ ${channelsToUpdate.length} قناة`);
                
                const apiKey = await getApiKey();
                if (apiKey) {
                    for (let channel of channelsToUpdate) {
                        if (apiCallCount > 950) break;
                        
                        try {
                            await updateChannelFromAPI(channel, apiKey);
                            await new Promise(resolve => setTimeout(resolve, 200)); // تأخير بين الطلبات
                        } catch (error) {
                            logDebug('error', `✗ فشل تحديث قناة: ${error.message}`);
                        }
                    }
                }
            }
            
            lastSmartUpdate = Date.now();
        }
        
        function updateSmartApiDisplay() {
            const smartApiStatus = document.getElementById('smartApiStatus');
            if (!smartApiStatus || !debugMode) return;
            
            const nextUpdateIn = Math.max(0, Math.ceil((lastSmartUpdate + 300000 - Date.now()) / 60000)); // 5 دقائق
            const highPriorityChannels = [...channelPriorities.entries()]
                .filter(([id, priority]) => priority > 50)
                .length;
            
            const apiBudget = Math.max(0, 1000 - apiCallCount);
            const estimatedUpdates = Math.floor(apiBudget / 5);
            
            let statusColor = 'debug-success';
            let statusIcon = '🟢';
            let statusText = 'مثالي';
            
            if (apiCallCount > 900) {
                statusColor = 'debug-error';
                statusIcon = '🔴';
                statusText = 'متوقف - حصة منخفضة';
            } else if (apiCallCount > 800) {
                statusColor = 'debug-warning';
                statusIcon = '🟡';
                statusText = 'محذر - استهلاك عالي';
            }
            
            smartApiStatus.innerHTML = `
                <div class="${statusColor}">
                    ${statusIcon} حالة النظام: ${statusText}
                </div>

            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-group">
                        <i class="fas fa-cog"></i>
                        <h3 class="section-title">إعدادات YouTube API</h3>
                    </div>
                </div>
                <div class="section-content">
                    <div class="settings-grid">
                        <input type="text" id="ytKey" class="settings-input" placeholder="YouTube API Key">
                        <button class="btn btn-save" onclick="saveKey()">
                            <i class="fas fa-save"></i>
                            حفظ
                        </button>
                    </div>
                    <div class="settings-grid">
                        <div></div>
                        <button class="test-api-btn" onclick="testYouTubeAPI()">
                            <i class="fas fa-flask"></i>
                            اختبار API
                        </button>
                    </div>
                </div>
            </div>
                <div class="debug-success">🎯 قنوات عالية الأولوية: ${highPriorityChannels}</div>
                <div class="debug-success">💰 ميزانية API متبقية: ${apiBudget} (≈${estimatedUpdates} تحديث)</div>
                <div class="debug-success">⏰ التحديث التالي خلال: ${nextUpdateIn} دقيقة</div>
                <div class="debug-success">🔄 آخر تحديث ذكي: ${lastSmartUpdate ? formatTimeAgo(lastSmartUpdate) : 'لم يتم بعد'}</div>
            `;
        }
        
        function formatTimeAgo(timestamp) {
            const minutes = Math.floor((Date.now() - timestamp) / 60000);
            if (minutes < 1) return 'الآن';
            if (minutes < 60) return `${minutes} دقيقة`;
            const hours = Math.floor(minutes / 60);
            return `${hours} ساعة`;
        }
        
        // تحسين مراقب API ليشمل التنبيهات الذكية
        function updateApiMonitor() {
            if (!debugMode) return;
            
            const now = Date.now();
            
            // إعادة تعيين العداد كل ساعة
            if (now - lastApiReset > 3600000) {
                apiCallCount = 0;
                lastApiReset = now;
                logDebug('success', '🔄 تم إعادة تعيين عداد API (ساعة جديدة)');
                addAuditEntry('إعادة تعيين API', 'بداية ساعة جديدة');
            }
            
            const remaining = Math.max(0, 1000 - apiCallCount);
            const hitRate = totalRequests > 0 ? Math.round((cacheHits / totalRequests) * 100) : 0;
            
            // تحديث الأرقام
            document.getElementById('apiCallsCount').textContent = apiCallCount;
            document.getElementById('apiQuotaRemaining').textContent = remaining;
            document.getElementById('cacheHitRate').textContent = hitRate + '%';
            document.getElementById('cacheSizeDisplay').textContent = cacheStats.size;
            
            // تحديث ألوان المؤشرات
            const callsElement = document.getElementById('apiCallsCount');
            const remainingElement = document.getElementById('apiQuotaRemaining');
            
            // إشارات تحذيرية للحصة مع اقتراحات ذكية
            const warningDiv = document.getElementById('apiQuotaWarning');
            warningDiv.innerHTML = '';
            
            if (apiCallCount > 950) {
                callsElement.style.color = '#dc3545';
                remainingElement.style.color = '#dc3545';
                warningDiv.innerHTML = `
                    <div class="api-quota-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>تحذير حرج:</strong> وشك نفاد حصة API!
                        <br><small>💡 الحلول: انتظار الساعة القادمة، الاعتماد على الكاش، أو استخدام مفتاح API إضافي</small>
                    </div>
                `;
                disableApiFeatures(true);
                smartApiEnabled = false;
            } else if (apiCallCount > 800) {
                callsElement.style.color = '#ffc107';
                remainingElement.style.color = '#ffc107';
                const estimatedTime = Math.ceil((1000 - apiCallCount) / 10); // تقدير الوقت المتبقي بالدقائق
                warningDiv.innerHTML = `
                    <div class="api-quota-warning">
                        <i class="fas fa-exclamation-circle"></i> 
                        <strong>تحذير:</strong> حصة API منخفضة (${remaining} متبقية)
                        <br><small>💡 سيتم التركيز على القنوات        async function addChannelQuick() {
            const channelInput = document.getElementById('quickChannelUrl').value.trim();
            
            if (!channelInput) {
                showNotification('يرجى إدخال رابط القناة أو المعرف', 'error');
                logDebug('error', '✗ محاولة إضافة قناة بدون رابط');
                return;
            }
            
            // تحويل المدخل إلى رابط كامل إذا لزم الأمر
            const fullUrl = normalizeChannelInput(channelInput);
            if (!fullUrl) {
                showNotification('صيغة غير صحيحة. استخدم رابط كامل أو @username أو معرف القناة', 'error');
                logDebug('error', `✗ صيغة غير صحيحة: ${channelInput}`);
                return;
            }
            
            try {
                showNotification('جاري التحقق من القناة...', 'success');
                logDebug('success', `🔍 جاري البحث عن معلومات القناة: ${channelInput}`);
                
                // جلب معلومات القناة من YouTube API
                const apiKey = await getApiKey();
                if (!apiKey) {
                    showNotification('لا يوجد مفتاح YouTube API. سيتم إضافة القناة بدون معلومات', 'warning');
                    await addChannelWithoutAPI(fullUrl, channelInput);
                    return;
                }
                
                if (apiCallCount > 950) {
                    showNotification('حصة API منخفضة. سيتم إضافة القناة بدون معلومات', 'warning');
                    await addChannelWithoutAPI(fullUrl, channelInput);
                    return;
                }
                
                const channelData = await fetchChannelDataFromInput(channelInput, apiKey);
                
                if (channelData) {
                    await addChannelWithData(channelData, fullUrl);
                } else {
                    await addChannelWithoutAPI(fullUrl, channelInput);
                }
                
                document.getElementById('quickChannelUrl').value = '';
                
            } catch (error) {
                console.error('خطأ في إضافة القناة:', error);
                logDebug('error', `✗ خطأ في إضافة القناة: ${error.message}`);
                showNotification('حدث خطأ أثناء إضافة القناة', 'error');
            }
        }
